name: Provision GKE Cluster

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  terraform:
    name: Apply Terraform
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.6

    - name: Install Infisical CLI
      run: |
        curl -1sLf \
        'https://artifacts-cli.infisical.com/setup.deb.sh' \
        | sudo -E bash
        sudo apt-get update && sudo apt-get install -y infisical
    - name: Install gke-cloud-auth-plugin
      run: |
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        sudo apt-get update
        sudo apt-get install google-cloud-sdk-gke-gcloud-auth-plugin
        
    - name: Authenticate to GCP via Infisical & setup kubeconfig
      run: |
        infisical run --env=prod -- \
          bash -c '
            # 1. Auth GCP bằng SA key lấy từ Infisical
            gcloud auth activate-service-account --key-file=<(echo "$GCP_SA_KEY")

            # 2. Set project
            gcloud config set project "$GCP_PROJECT_ID"

            # 3. Set region
            gcloud config set compute/region "asia-southeast1"
            
            # 4. Lấy kubeconfig cho GKE cluster
            echo "Fetching kubeconfig for GKE cluster..."
            gcloud container clusters get-credentials "light-cluster" --region "asia-southeast1"
            # 5. check kubeconfig
            echo "Kubeconfig file content:"
            cat ~/.kube/config
            # 6. Check kubectl
            echo "Checking kubectl configuration..."
            kubectl get ns

          '
      env:
        INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}

    - name: Terraform Init and plan
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -var-file="terraform.tfvars"

    - name: Terraform Apply
      run: terraform apply -auto-approve -var-file="terraform.tfvars"
